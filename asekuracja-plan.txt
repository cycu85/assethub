# PLAN IMPLEMENTACJI MODUŁU "ASEKURACJA"

## WYMAGANIA FUNKCJONALNE

### Główne funkcjonalności:
1. Lista sprzętu ✅
2. Dane zakupowe dla sprzętu ✅
3. Możliwość tworzenia zestawów ✅
4. Dodawanie elementów do zestawu jako popup/modal z listą dostępnych elementów (z możliwością filtrowania i wyszukiwania) i możliwość wybrania wielu zaznaczając Checkbox
5. Możliwość tworzenia przeglądów (workflow Przygotowanie do przeglądu > wysłanie na przegląd -> powrót z przeglądu) ✅
6. Przeglądy zarówno dla pojedynczych elementów jak i dla zestawów ✅
7. Przeglądy dla wybranych elementów zestawu ✅
8. Przekazanie do pracowników (workflow Generowanie przekazania -> dodanie skanu przekazania i zakończenie flow) ✅
9. Generowanie protokołu przekazania w formacie pdf
10. Słowniki w /admin/dictionaries/
11. Możliwość załączanie i wyłączania modułu ✅
12. Role ✅:
    a. System_admin - widzi wszystko ✅
    b. Assek_admin - pełne prawa do modułu ✅
    c. Assek_editor - nie może usuwać ✅
    d. Assek_viewer - tylko podgląd ✅
    e. Assek_list - tylko lista zestawów i elementów ✅
    f. Pracownik do którego przypisany jest sprzęt/zestaw widzi tylko swoje zestawy/sprzety bez edcji ✅
13. Powiadomienia email o zbliżających się terminach przeglądu dla pracownika, Assek_admin, Assek_editor
14. Powiadomienia w dzwoneczku o przeglądach dla pracownika, Assek_admin, Assek_editor
15. Raport zbiorczy email o zbliżających się przeglądach dla Assek_admin, Assek_editor

## ARCHITEKTURA ENTERPRISE ✅

### Wzorce zaimplementowane:
- ✅ Service Layer Pattern - separacja logiki biznesowej
- ✅ CQRS - komendy i zapytania
- ✅ Event-Driven Architecture - zdarzenia domenowe
- ✅ AuthorizationService - centralna autoryzacja
- ✅ AuditService - kompleksowy audit trail

### Struktura folderów ✅:
```
src/AsekuracyjnySPM/
├── Entity/ ✅
│   ├── AsekuracyjnyEquipment.php ✅
│   ├── AsekuracyjnyEquipmentSet.php ✅
│   ├── AsekuracyjnyReview.php ✅
│   ├── AsekuracyjnyTransfer.php ✅
│   └── AsekuracyjnyNotification.php
├── Service/ ✅
│   ├── AsekuracyjnyService.php ✅
│   ├── ReviewService.php
│   ├── TransferService.php
│   └── NotificationService.php
├── Controller/
│   ├── AsekuracyjnyController.php
│   ├── EquipmentSetController.php
│   ├── ReviewController.php
│   └── TransferController.php
├── Repository/ ✅
│   ├── AsekuracyjnyEquipmentRepository.php ✅
│   ├── AsekuracyjnyEquipmentSetRepository.php ✅
│   ├── AsekuracyjnyReviewRepository.php ✅
│   └── AsekuracyjnyTransferRepository.php ✅
├── Form/
├── Command/
├── Query/
├── Event/
└── EventSubscriber/
```

## SCHEMA BAZY DANYCH ✅

### Encje główne ✅:
1. **AsekuracyjnyEquipment** - sprzęt asekuracyjny ✅
2. **AsekuracyjnyEquipmentSet** - zestawy sprzętu ✅
3. **AsekuracyjnyReview** - przeglądy ✅
4. **AsekuracyjnyTransfer** - przekazania ✅
5. **AsekuracyjnyNotification** - powiadomienia

### Relacje ✅:
- Equipment N:M EquipmentSet (przez tabelę AsekuracyjnyEquipmentSetItem) ✅
- Equipment 1:N Review ✅
- EquipmentSet 1:N Review ✅
- Equipment 1:N Transfer ✅
- EquipmentSet 1:N Transfer ✅
- User 1:N Equipment (assigned_to) ✅
- User 1:N EquipmentSet (assigned_to) ✅

## ROLE I UPRAWNIENIA ✅

### Moduł zarejestrowany ✅:
```sql
INSERT INTO modules (name, display_name, description, is_enabled, created_at, updated_at) 
VALUES ('asekuracja', 'Asekuracja', 'Zarządzanie sprzętem asekuracyjnym/wysokościowym', 1, NOW(), NOW());
```

### Role utworzone ✅:
```sql
INSERT INTO roles (name, description, permissions, module_id, is_system_role, created_at, updated_at) VALUES
('ASSEK_ADMIN', 'Administrator Asekuracji - pełne prawa do modułu', '["VIEW","CREATE","EDIT","DELETE","ASSIGN","REVIEW","TRANSFER"]', 3, 0, NOW(), NOW()),
('ASSEK_EDITOR', 'Edytor Asekuracji - bez uprawnień do usuwania', '["VIEW","CREATE","EDIT","ASSIGN","REVIEW","TRANSFER"]', 3, 0, NOW(), NOW()),
('ASSEK_VIEWER', 'Przeglądający Asekuracji - tylko podgląd', '["VIEW"]', 3, 0, NOW(), NOW()),
('ASSEK_LIST', 'Lista Asekuracji - tylko lista zestawów i elementów', '["VIEW_LIST"]', 3, 0, NOW(), NOW());
```

## FUNKCJONALNOŚCI GŁÓWNE

### 1. Zarządzanie sprzętem ✅
- ✅ Lista z filtrowaniem i wyszukiwaniem (repository)
- ✅ CRUD z danymi zakupowymi (service)
- ✅ Status (dostępny, przypisany, na przeglądzie, uszkodzony)
- ✅ Przypisywanie/cofanie przypisań (service)

### 2. Zestawy sprzętu ✅
- ✅ Tworzenie zestawów tematycznych (entity + service)
- Modal z wyborem sprzętu (multi-select) - TODO: kontroler + template
- ✅ Zarządzanie składnikami zestawu (service)

### 3. System przeglądów ✅
- ✅ Workflow: Przygotowanie → Wysłanie → Powrót (entity)
- ✅ Przeglądy pojedynczych elementów i zestawów (entity)
- ✅ Wybrane elementy z zestawu (selectedEquipmentIds)
- ✅ Terminy następnych przeglądów (entity)

### 4. Przekazania pracownikom ✅
- ✅ Workflow: Generowanie → Skan → Zakończenie (entity)
- Protokoły PDF - TODO: service
- ✅ Historia przekazań (repository)

### 5. Powiadomienia
- Email o zbliżających się przeglądach - TODO: service
- Powiadomienia w aplikacji (dzwoneczek) - TODO: service
- Raporty zbiorcze dla adminów - TODO: service

## SŁOWNIKI

### Do utworzenia:
```sql
-- Typy sprzętu
INSERT INTO dictionaries (type, name, value, description, is_active, is_system, sort_order, created_at, updated_at) VALUES 
('assek_equipment_types', 'Szelki', 'harness', 'Szelki asekuracyjne', 1, 1, 1, NOW(), NOW()),
('assek_equipment_types', 'Liny', 'rope', 'Liny asekuracyjne', 1, 1, 2, NOW(), NOW()),
('assek_equipment_types', 'Kaski', 'helmet', 'Kaski ochronne', 1, 1, 3, NOW(), NOW()),
('assek_equipment_types', 'Zacisk', 'ascender', 'Zaciski i żumar', 1, 1, 4, NOW(), NOW());

-- Statusy przeglądu
INSERT INTO dictionaries (type, name, value, description, is_active, is_system, sort_order, created_at, updated_at) VALUES 
('assek_review_status', 'Przygotowanie', 'preparation', 'Przygotowanie do przeglądu', 1, 1, 1, NOW(), NOW()),
('assek_review_status', 'Na przeglądzie', 'in_review', 'Wysłane na przegląd', 1, 1, 2, NOW(), NOW()),
('assek_review_status', 'Zakończone', 'completed', 'Przegląd zakończony', 1, 1, 3, NOW(), NOW());

-- Typy zestawów
INSERT INTO dictionaries (type, name, value, description, is_active, is_system, sort_order, created_at, updated_at) VALUES 
('assek_set_types', 'Podstawowy', 'basic', 'Podstawowy zestaw asekuracyjny', 1, 1, 1, NOW(), NOW()),
('assek_set_types', 'Zaawansowany', 'advanced', 'Zaawansowany zestaw asekuracyjny', 1, 1, 2, NOW(), NOW()),
('assek_set_types', 'Specjalistyczny', 'specialist', 'Specjalistyczny zestaw asekuracyjny', 1, 1, 3, NOW(), NOW());
```

## CHECKLIST IMPLEMENTACJI

### ✅ ZAIMPLEMENTOWANE:
- [✅] **Analiza wymagań i plan architektoniczny**
- [✅] **Projekt schematu bazy danych z encjami i relacjami**
- [✅] **Rejestracja modułu w systemie (modules, roles)**
- [✅] **Utworzenie encji głównych (Equipment, EquipmentSet, Review, Transfer)**
- [✅] **Implementacja repozytoriów dla wszystkich encji**
- [✅] **AsekuracyjnyService - główna logika biznesowa**

### 🔄 DO ZAIMPLEMENTOWANIA:

#### Serwisy biznesowe:
- [ ] **ReviewService** - zarządzanie przeglądami z workflow
- [ ] **TransferService** - przekazania pracownikom z generowaniem PDF
- [ ] **NotificationService** - powiadomienia email i w aplikacji

#### Kontrolery z autoryzacją:
- [ ] **AsekuracyjnyController** - główny kontroler sprzętu
- [ ] **EquipmentSetController** - zarządzanie zestawami
- [ ] **ReviewController** - system przeglądów
- [ ] **TransferController** - przekazania pracownikom

#### Formularze Symfony:
- [ ] **AsekuracyjnyEquipmentType** - formularz sprzętu
- [ ] **AsekuracyjnyEquipmentSetType** - formularz zestawu
- [ ] **AsekuracyjnyReviewType** - formularz przeglądu
- [ ] **AsekuracyjnyTransferType** - formularz przekazania
- [ ] **EquipmentSelectionType** - wybór sprzętu do zestawu (modal)

#### Szablony Twig z Bootstrap:
- [ ] **equipment/index.html.twig** - lista sprzętu
- [ ] **equipment/show.html.twig** - szczegóły sprzętu
- [ ] **equipment/form.html.twig** - formularz sprzętu
- [ ] **equipment-set/index.html.twig** - lista zestawów
- [ ] **equipment-set/show.html.twig** - szczegóły zestawu + modal wyboru
- [ ] **review/index.html.twig** - lista przeglądów
- [ ] **transfer/index.html.twig** - lista przekazań

#### System generowania PDF:
- [ ] **Protokół przekazania** - generowanie PDF z TCPDF/mPDF
- [ ] **Szablon protokołu** - profesjonalny layout z logo

#### Powiadomienia:
- [ ] **EmailNotificationService** - powiadomienia email
- [ ] **InAppNotificationService** - powiadomienia w dzwoneczku
- [ ] **ReportService** - raporty zbiorcze email

#### Słowniki w panelu admin:
- [ ] **Dodanie typów sprzętu do słowników**
- [ ] **Dodanie statusów przeglądu do słowników**
- [ ] **Dodanie typów zestawów do słowników**

#### Dane przykładowe:
- [ ] **AsekuracyjnyFixtures** - dane testowe dla instalatora
- [ ] **Przykładowy sprzęt i zestawy**
- [ ] **Przykładowe przeglądy i przekazania**

#### Testy jednostkowe:
- [ ] **AsekuracyjnyServiceTest** - test serwisu głównego
- [ ] **ReviewServiceTest** - test serwisu przeglądów
- [ ] **TransferServiceTest** - test serwisu przekazań
- [ ] **AsekuracyjnyControllerTest** - test kontrolera
- [ ] **Repository tests** - testy repozytoriów

#### Menu i routing:
- [ ] **Dodanie modułu do menu bocznego** (templates/partials/sidebar.html.twig)
- [ ] **Konfiguracja route'ów** - wszystkie ścieżki modułu
- [ ] **Breadcrumbs** - nawigacja w szablonach

#### Dokumentacja:
- [ ] **README modułu** - instrukcja instalacji i konfiguracji
- [ ] **Dokumentacja API** - opis endpointów
- [ ] **Instrukcja użytkownika** - jak korzystać z modułu

## WZORCE I KONWENCJE

### Zgodność z kontekstem aplikacji ✅:
- ✅ **Service Layer Pattern** - wszystkie operacje przez serwisy
- ✅ **AuthorizationService** - sprawdzanie uprawnień w kontrolerach
- ✅ **AuditService** - logowanie wszystkich działań
- ✅ **Repository Pattern** - zaawansowane zapytania w repozytoriach
- ✅ **Entity Lifecycle** - automatyczne timestampy
- ✅ **Validation** - Symfony validators w encjach

### Konwencje nazewnictwa ✅:
- ✅ **Kontrolery**: `AsekuracyjnyController`, `ReviewController`
- ✅ **Encje**: `AsekuracyjnyEquipment`, `AsekuracyjnyReview`
- ✅ **Repozytoria**: `AsekuracyjnyEquipmentRepository`
- ✅ **Serwisy**: `AsekuracyjnyService`, `ReviewService`
- ✅ **Szablony**: `asekuracja/{action}.html.twig`

## PRIORYTET IMPLEMENTACJI

### Faza 1 - Podstawowa funkcjonalność:
1. **ReviewService** i **TransferService**
2. **Kontrolery główne** z autoryzacją
3. **Podstawowe formularze** i szablony
4. **Menu i routing**

### Faza 2 - Zaawansowane funkcje:
1. **Modal wyboru sprzętu** do zestawów
2. **Generowanie PDF** protokołów
3. **System powiadomień**
4. **Słowniki** w panelu admin

### Faza 3 - Finalizacja:
1. **Testy jednostkowe**
2. **Dane przykładowe**
3. **Dokumentacja**
4. **Optymalizacja** i poprawki

## STATUS: FUNDAMENT ENTERPRISE GOTOWY ✅

Moduł ma solidne fundamenty zgodne z wzorcami enterprise z kontekstu aplikacji.
Wszystkie encje, repozytoria i główny serwis biznesowy są gotowe.
System ról i uprawnień skonfigurowany.
Gotowy do implementacji warstwy prezentacji i pozostałych serwisów.