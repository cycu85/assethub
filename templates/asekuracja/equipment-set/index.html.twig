{% extends 'base.html.twig' %}

{% block title %}Zestawy sprzętu asekuracyjnego - {{ app_name() }}{% endblock %}
{% block page_title %}Zestawy sprzętu{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-md-8">
        <h4 class="mb-0">
            <i class="ri-stack-line me-2 text-primary"></i>
            Zestawy sprzętu asekuracyjnego
        </h4>
        <p class="text-muted mb-0">Zarządzanie zestawami tematycznymi sprzętu bezpieczeństwa</p>
    </div>
    <div class="col-md-4 text-end">
        {% if can_create %}
        <a href="{{ path('asekuracja_equipment_set_new') }}" class="btn btn-primary">
            <i class="ri-add-line me-1"></i>
            Nowy zestaw
        </a>
        {% endif %}
        <a href="{{ path('asekuracja_index') }}" class="btn btn-outline-secondary ms-2">
            <i class="ri-shield-line me-1"></i>
            Sprzęt
        </a>
    </div>
</div>

<!-- Statystyki zestawów -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card border-0 shadow-sm">
            <div class="card-body">
                <div class="d-flex align-items-center">
                    <div class="avatar-sm bg-primary rounded">
                        <i class="ri-stack-line text-white fs-16"></i>
                    </div>
                    <div class="ms-3">
                        <h5 class="mb-0">{{ statistics.total }}</h5>
                        <p class="text-muted mb-0">Łącznie zestawów</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card border-0 shadow-sm">
            <div class="card-body">
                <div class="d-flex align-items-center">
                    <div class="avatar-sm bg-success rounded">
                        <i class="ri-check-line text-white fs-16"></i>
                    </div>
                    <div class="ms-3">
                        <h5 class="mb-0">{{ statistics.available }}</h5>
                        <p class="text-muted mb-0">Dostępne</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card border-0 shadow-sm">
            <div class="card-body">
                <div class="d-flex align-items-center">
                    <div class="avatar-sm bg-warning rounded">
                        <i class="ri-user-line text-white fs-16"></i>
                    </div>
                    <div class="ms-3">
                        <h5 class="mb-0">{{ statistics.assigned }}</h5>
                        <p class="text-muted mb-0">Przypisane</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card border-0 shadow-sm">
            <div class="card-body">
                <div class="d-flex align-items-center">
                    <div class="avatar-sm bg-info rounded">
                        <i class="ri-tools-line text-white fs-16"></i>
                    </div>
                    <div class="ms-3">
                        <h5 class="mb-0">{{ statistics.incomplete }}</h5>
                        <p class="text-muted mb-0">Niekompletne</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Filtry -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-body">
                <form method="GET" class="row g-3">
                    <div class="col-md-4">
                        <label class="form-label">Szukaj</label>
                        <div class="input-group">
                            <span class="input-group-text">
                                <i class="ri-search-line"></i>
                            </span>
                            <input type="text" name="search" class="form-control" 
                                   placeholder="Nazwa zestawu, opis..." 
                                   value="{{ filters.search }}">
                        </div>
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">Status</label>
                        <select name="status" class="form-select">
                            <option value="">Wszystkie</option>
                            <option value="available" {{ filters.status == 'available' ? 'selected' : '' }}>Dostępne</option>
                            <option value="assigned" {{ filters.status == 'assigned' ? 'selected' : '' }}>Przypisane</option>
                            <option value="in_review" {{ filters.status == 'in_review' ? 'selected' : '' }}>Na przeglądzie</option>
                            <option value="incomplete" {{ filters.status == 'incomplete' ? 'selected' : '' }}>Niekompletne</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">Typ zestawu</label>
                        <select name="set_type" class="form-select">
                            <option value="">Wszystkie typy</option>
                            <option value="basic" {{ filters.set_type == 'basic' ? 'selected' : '' }}>Podstawowy</option>
                            <option value="advanced" {{ filters.set_type == 'advanced' ? 'selected' : '' }}>Zaawansowany</option>
                            <option value="specialist" {{ filters.set_type == 'specialist' ? 'selected' : '' }}>Specjalistyczny</option>
                            <option value="rescue" {{ filters.set_type == 'rescue' ? 'selected' : '' }}>Ratowniczy</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">Specjalne filtry</label>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" name="needs_review" 
                                   {{ filters.needs_review ? 'checked' : '' }} id="needs_review">
                            <label class="form-check-label" for="needs_review">
                                Wymagają przeglądu
                            </label>
                        </div>
                    </div>
                    <div class="col-md-2 d-flex align-items-end">
                        <button type="submit" class="btn btn-primary me-2">
                            <i class="ri-search-line me-1"></i>
                            Filtruj
                        </button>
                        <a href="{{ path('asekuracja_equipment_set_index') }}" class="btn btn-outline-secondary">
                            <i class="ri-refresh-line"></i>
                        </a>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Lista zestawów -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <div class="d-flex align-items-center">
                    <h5 class="card-title mb-0 flex-grow-1">Lista zestawów</h5>
                </div>
            </div>
            <div class="card-body">
                {% if equipment_sets.items|length > 0 %}
                <div class="row mb-3">
                    <div class="col-sm-12 col-md-6">
                        <!-- Puste miejsce po lewej -->
                    </div>
                    <div class="col-sm-12 col-md-6">
                        <div class="d-flex align-items-center justify-content-end">
                            <label for="page-size-select" class="form-label me-2 mb-0">Pokaż:</label>
                            <select id="page-size-select" class="form-select form-select-sm" style="width: auto;">
                                <option value="10" selected>10</option>
                                <option value="25">25</option>
                                <option value="50">50</option>
                                <option value="100">100</option>
                                <option value="250">250</option>
                                <option value="500">500</option>
                                <option value="1000">1000</option>
                                <option value="0">Wszystkie</option>
                            </select>
                            <span class="ms-2 text-muted">wierszy</span>
                        </div>
                    </div>
                </div>
                <div id="table-gridjs"></div>
                {% else %}
                <div class="text-center py-5">
                    <i class="ri-stack-line text-muted fs-48"></i>
                    <h5 class="mt-3">Brak zestawów sprzętu</h5>
                    <p class="text-muted">
                        {% if filters.search or filters.status or filters.set_type %}
                            Nie znaleziono zestawów odpowiadających wybranym filtrom.
                        {% else %}
                            Nie utworzono jeszcze żadnego zestawu sprzętu asekuracyjnego.
                        {% endif %}
                    </p>
                    {% if can_create and not filters.search and not filters.status and not filters.set_type %}
                    <a href="{{ path('asekuracja_equipment_set_new') }}" class="btn btn-primary">
                        <i class="ri-add-line me-1"></i>
                        Utwórz pierwszy zestaw
                    </a>
                    {% endif %}
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block head_css %}
{{ parent() }}
<!-- gridjs css -->
<link href="{{ asset('assets/libs/gridjs/theme/mermaid.min.css') }}" rel="stylesheet" type="text/css" />
<style>
.gridjs-table {
    border: none !important;
}
.gridjs-th {
    background-color: #f8f9fa !important;
    border: none !important;
    color: #495057 !important;
    font-weight: 600 !important;
}
.gridjs-td {
    border: none !important;
    border-bottom: 1px solid #dee2e6 !important;
}
.gridjs-sort {
    color: #495057 !important;
}
.gridjs-sort::after {
    content: "\f0dc" !important;
    font-family: "Font Awesome 5 Free" !important;
    font-weight: 900 !important;
}
.gridjs-sort-asc::after {
    content: "\f0de" !important;
}
.gridjs-sort-desc::after {
    content: "\f0dd" !important;
}
.gridjs-td {
    white-space: nowrap !important;
}
.gridjs-td:nth-child(1),
.gridjs-td:nth-child(3) {
    white-space: normal !important;
    word-wrap: break-word !important;
    word-break: break-word !important;
    max-width: 200px !important;
}
/* Fix search input styling */
.gridjs-search-input {
    padding-left: 35px !important;
}
.gridjs-search {
    position: relative !important;
}
.gridjs-search::before {
    content: "\f002" !important;
    font-family: "Font Awesome 5 Free" !important;
    font-weight: 900 !important;
    position: absolute !important;
    left: 12px !important;
    top: 50% !important;
    transform: translateY(-50%) !important;
    color: #6c757d !important;
    z-index: 10 !important;
    pointer-events: none !important;
}
</style>
{% endblock %}

{% block javascript %}
<!-- gridjs js -->
<script src="{{ asset('assets/libs/gridjs/gridjs.umd.js') }}"></script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Prepare data for GridJS
    const equipmentSetsData = [
        {% for set in equipment_sets.items %}
        [
            gridjs.html(`
                <div class="d-flex align-items-center">
                    <div class="avatar-sm bg-light rounded me-3">
                        <i class="ri-stack-line text-primary fs-16"></i>
                    </div>
                    <div>
                        <h6 class="mb-0">
                            <a href="{{ path('asekuracja_equipment_set_show', {id: set.id}) }}" class="text-dark text-decoration-none">
                                {{ set.name }}
                            </a>
                        </h6>
                        {% if set.description %}
                        <span class="text-muted small">{{ set.description|slice(0, 60) }}{% if set.description|length > 60 %}...{% endif %}</span>
                        {% endif %}
                    </div>
                </div>
            `),
            gridjs.html(`<span class="badge bg-info">{{ set.setType ?: 'Podstawowy' }}</span>`),
            gridjs.html(`
                <div class="d-flex align-items-center">
                    <span class="fw-medium">{{ set.equipmentItems|length }}</span>
                    <span class="text-muted ms-1">elementów</span>
                    {% if set.isComplete %}
                    <i class="ri-check-line text-success ms-2" title="Zestaw kompletny"></i>
                    {% else %}
                    <i class="ri-error-warning-line text-warning ms-2" title="Zestaw niekompletny"></i>
                    {% endif %}
                </div>
                {% if set.equipmentItems|length > 0 %}
                <div class="mt-1">
                    {% for item in set.equipmentItems|slice(0, 3) %}
                    <small class="badge bg-light text-dark me-1">{{ item.equipmentType }}</small>
                    {% endfor %}
                    {% if set.equipmentItems|length > 3 %}
                    <small class="text-muted">+{{ set.equipmentItems|length - 3 }} więcej</small>
                    {% endif %}
                </div>
                {% endif %}
            `),
            gridjs.html(`
                {% set status_class = set.status == 'available' ? 'success' : (set.status == 'assigned' ? 'warning' : (set.status == 'in_review' ? 'info' : 'secondary')) %}
                <span class="badge bg-{{ status_class }}">{{ set.statusDisplayName }}</span>
            `),
            gridjs.html(`
                {% if set.assignedTo %}
                    <span class="text-dark">{{ set.assignedTo.fullName }}</span>
                    <br><small class="text-muted">{{ set.assignedDate|date('d.m.Y') }}</small>
                {% else %}
                    <span class="text-muted">Nieprzypisany</span>
                {% endif %}
            `),
            gridjs.html(`
                {% if set.nextReviewDate %}
                    {% set review_date = set.nextReviewDate|date('Y-m-d') %}
                    {% set today_date = 'now'|date('Y-m-d') %}
                    {% if review_date < today_date %}
                        {% set days_overdue = date().diff(date(set.nextReviewDate)).days %}
                        <span class="text-danger">
                            <i class="ri-error-warning-line me-1"></i>{{ set.nextReviewDate|date('d.m.Y') }}
                            <br><small>Przeterminowany o {{ days_overdue }} dni!</small>
                        </span>
                    {% else %}
                        {% set days_to_review = date(set.nextReviewDate).diff(date()).days %}
                        {% if days_to_review <= 30 %}
                            <span class="text-warning">
                                <i class="ri-time-line me-1"></i>{{ set.nextReviewDate|date('d.m.Y') }}
                                <br><small>Za {{ days_to_review }} dni</small>
                            </span>
                        {% else %}
                            <span class="text-muted">
                                {{ set.nextReviewDate|date('d.m.Y') }}
                                <br><small>Za {{ days_to_review }} dni</small>
                            </span>
                        {% endif %}
                    {% endif %}
                {% else %}
                    <span class="text-muted">Nie określono</span>
                {% endif %}
            `),
            gridjs.html(`
                <div class="dropdown">
                    <button class="btn btn-light btn-sm dropdown-toggle" type="button" data-bs-toggle="dropdown">Akcje</button>
                    <ul class="dropdown-menu">
                        <li><a class="dropdown-item" href="{{ path('asekuracja_equipment_set_show', {id: set.id}) }}"><i class="ri-eye-line me-2"></i>Szczegóły</a></li>
                        {% if can_edit %}
                        <li><a class="dropdown-item" href="{{ path('asekuracja_equipment_set_edit', {id: set.id}) }}"><i class="ri-edit-line me-2"></i>Edytuj</a></li>
                        <li><a class="dropdown-item" href="{{ path('asekuracja_equipment_set_add_equipment', {id: set.id}) }}"><i class="ri-settings-3-line me-2"></i>Zarządzaj sprzętem</a></li>
                        {% endif %}
                        {% if can_review %}
                        <li><hr class="dropdown-divider"></li>
                        <li><a class="dropdown-item" href="{{ path('asekuracja_review_new_for_set', {id: set.id}) }}"><i class="ri-search-eye-line me-2"></i>Nowy przegląd</a></li>
                        {% endif %}
                    </ul>
                </div>
            `)
        ]{% if not loop.last %},{% endif %}
        {% endfor %}
    ];

    let currentGrid;

    function createGrid(pageSize = 10) {
        const gridConfig = {
            columns: [
                { name: 'Zestaw', width: '250px' },
                { name: 'Typ', width: '100px' },
                { name: 'Elementy', width: '200px' },
                { name: 'Status', width: '100px' },
                { name: 'Przypisane do', width: '150px' },
                { name: 'Następny przegląd', width: '150px' },
                { name: 'Akcje', width: '120px', sort: false }
            ],
            data: equipmentSetsData,
            sort: true,
            search: true,
            className: {
                table: 'table table-borderless table-centered align-middle table-nowrap mb-0',
                th: 'text-muted',
                td: 'text-body'
            },
            language: {
                search: { placeholder: 'Szukaj...' },
                pagination: {
                    previous: 'Poprzednia',
                    next: 'Następna',
                    showing: 'Pokazane',
                    results: () => 'wyniki'
                }
            }
        };

        if (pageSize > 0) {
            gridConfig.pagination = {
                limit: pageSize,
                summary: true
            };
        }

        if (currentGrid) {
            currentGrid.destroy();
        }

        currentGrid = new gridjs.Grid(gridConfig).render(document.getElementById("table-gridjs"));
    }

    createGrid(10);

    document.getElementById('page-size-select').addEventListener('change', function() {
        const pageSize = parseInt(this.value);
        createGrid(pageSize);
    });
});
</script>
{% endblock %}