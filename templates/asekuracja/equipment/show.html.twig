{% extends 'base.html.twig' %}

{% block title %}{{ equipment.name }} - Sprzęt asekuracyjny - {{ app_name() }}{% endblock %}
{% block page_title %}{{ equipment.name }}{% endblock %}

{% block content %}
<!-- Breadcrumb -->
<div class="row">
    <div class="col-12">
        <div class="page-title-box d-sm-flex align-items-center justify-content-between">
            <ol class="breadcrumb m-0">
                <li class="breadcrumb-item"><a href="{{ path('dashboard') }}">Dashboard</a></li>
                <li class="breadcrumb-item"><a href="{{ path('asekuracja_index') }}">Asekuracja</a></li>
                <li class="breadcrumb-item active">{{ equipment.name }}</li>
            </ol>
        </div>
    </div>
</div>

<!-- Header -->
<div class="row mb-4">
    <div class="col-md-8">
        <div class="d-flex align-items-center">
            <div class="avatar-lg bg-primary rounded me-3">
                <i class="ri-shield-check-line text-white fs-24"></i>
            </div>
            <div>
                <h4 class="mb-1">{{ equipment.name }}</h4>
                <p class="text-muted mb-0">
                    <span class="badge bg-secondary me-2">{{ equipment.equipmentType }}</span>
                    {{ equipment.inventoryNumber }}
                </p>
            </div>
        </div>
    </div>
    <div class="col-md-4 text-end">
        {% if can_edit %}
        <a href="{{ path('asekuracja_equipment_edit', {id: equipment.id}) }}" class="btn btn-warning">
            <i class="ri-edit-line me-1"></i>Edytuj
        </a>
        {% endif %}
        
        {% if can_assign %}
            {% if equipment.isAssigned %}
            <form method="POST" action="{{ path('asekuracja_equipment_unassign', {id: equipment.id}) }}" 
                  class="d-inline ms-2" onsubmit="return confirm('Czy na pewno cofnąć przypisanie?')">
                <input type="hidden" name="_token" value="{{ csrf_token('unassign_equipment_' ~ equipment.id) }}">
                <button type="submit" class="btn btn-outline-warning">
                    <i class="ri-user-unfollow-line me-1"></i>Cofnij przypisanie
                </button>
            </form>
            {% else %}
            <a href="{{ path('asekuracja_equipment_assign', {id: equipment.id}) }}" class="btn btn-success ms-2">
                <i class="ri-user-add-line me-1"></i>Przypisz
            </a>
            {% endif %}
        {% endif %}

        <div class="btn-group ms-2" role="group">
            <button type="button" class="btn btn-outline-primary dropdown-toggle" data-bs-toggle="dropdown">
                <i class="ri-more-line"></i> Więcej
            </button>
            <ul class="dropdown-menu">
                {% if can_review %}
                <li><a class="dropdown-item" href="#"><i class="ri-search-eye-line me-2"></i>Nowy przegląd</a></li>
                {% endif %}
                {% if can_transfer %}
                <li><a class="dropdown-item" href="#"><i class="ri-share-forward-line me-2"></i>Przekaż</a></li>
                {% endif %}
                <li><hr class="dropdown-divider"></li>
                <li><a class="dropdown-item" href="{{ path('asekuracja_index') }}"><i class="ri-arrow-left-line me-2"></i>Powrót do listy</a></li>
                {% if can_delete and not equipment.isAssigned %}
                <li><hr class="dropdown-divider"></li>
                <li>
                    <form method="POST" action="{{ path('asekuracja_equipment_delete', {id: equipment.id}) }}" 
                          class="d-inline" onsubmit="return confirm('Czy na pewno usunąć ten sprzęt?')">
                        <input type="hidden" name="_token" value="{{ csrf_token('delete_equipment_' ~ equipment.id) }}">
                        <button type="submit" class="dropdown-item text-danger">
                            <i class="ri-delete-bin-line me-2"></i>Usuń
                        </button>
                    </form>
                </li>
                {% endif %}
            </ul>
        </div>
    </div>
</div>

<!-- Status i ostrzeżenia -->
<div class="row mb-4">
    <div class="col-12">
        {% if equipment.isReviewOverdue %}
        <div class="alert alert-danger">
            <i class="ri-error-warning-line me-2"></i>
            <strong>Przegląd przeterminowany!</strong>
            Termin przeglądu upłynął {{ equipment.nextReviewDate|date('d.m.Y') }}.
        </div>
        {% elseif equipment.needsReview %}
        <div class="alert alert-warning">
            <i class="ri-time-line me-2"></i>
            <strong>Zbliża się termin przeglądu</strong>
            Planowany przegląd: {{ equipment.nextReviewDate|date('d.m.Y') }}.
        </div>
        {% endif %}

        {% if equipment.isDamaged %}
        <div class="alert alert-danger">
            <i class="ri-error-warning-line me-2"></i>
            <strong>Sprzęt uszkodzony!</strong>
            Nie należy używać do czasu naprawy i przeglądu.
        </div>
        {% endif %}
    </div>
</div>

<!-- Główne informacje -->
<div class="row">
    <div class="col-xl-8">
        <!-- Podstawowe informacje -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="card-title mb-0">Podstawowe informacje</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label class="text-muted small">Nazwa sprzętu</label>
                            <p class="mb-0 fw-medium">{{ equipment.name }}</p>
                        </div>
                        <div class="mb-3">
                            <label class="text-muted small">Numer inwentarzowy</label>
                            <p class="mb-0">{{ equipment.inventoryNumber }}</p>
                        </div>
                        <div class="mb-3">
                            <label class="text-muted small">Typ sprzętu</label>
                            <p class="mb-0">
                                <span class="badge bg-secondary">{{ equipment.equipmentType }}</span>
                            </p>
                        </div>
                        <div class="mb-3">
                            <label class="text-muted small">Status</label>
                            <p class="mb-0">
                                {% set status_class = equipment.status == 'available' ? 'success' : 
                                                     (equipment.status == 'assigned' ? 'warning' : 
                                                     (equipment.status == 'damaged' ? 'danger' : 'secondary')) %}
                                <span class="badge bg-{{ status_class }}">{{ equipment.statusDisplayName }}</span>
                            </p>
                        </div>
                    </div>
                    <div class="col-md-6">
                        {% if equipment.manufacturer %}
                        <div class="mb-3">
                            <label class="text-muted small">Producent</label>
                            <p class="mb-0">{{ equipment.manufacturer }}</p>
                        </div>
                        {% endif %}
                        {% if equipment.model %}
                        <div class="mb-3">
                            <label class="text-muted small">Model</label>
                            <p class="mb-0">{{ equipment.model }}</p>
                        </div>
                        {% endif %}
                        {% if equipment.serialNumber %}
                        <div class="mb-3">
                            <label class="text-muted small">Numer seryjny</label>
                            <p class="mb-0">{{ equipment.serialNumber }}</p>
                        </div>
                        {% endif %}
                        {% if equipment.location %}
                        <div class="mb-3">
                            <label class="text-muted small">Lokalizacja</label>
                            <p class="mb-0">{{ equipment.location }}</p>
                        </div>
                        {% endif %}
                    </div>
                </div>
                
                {% if equipment.description %}
                <div class="mt-3">
                    <label class="text-muted small">Opis</label>
                    <p class="mb-0">{{ equipment.description }}</p>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Dane zakupowe -->
        {% if equipment.purchaseDate or equipment.purchasePrice or equipment.supplier %}
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="card-title mb-0">Dane zakupowe</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        {% if equipment.purchaseDate %}
                        <div class="mb-3">
                            <label class="text-muted small">Data zakupu</label>
                            <p class="mb-0">{{ equipment.purchaseDate|date('d.m.Y') }}</p>
                        </div>
                        {% endif %}
                        {% if equipment.purchasePrice %}
                        <div class="mb-3">
                            <label class="text-muted small">Cena zakupu</label>
                            <p class="mb-0">{{ equipment.purchasePrice|number_format(2, ',', ' ') }} PLN</p>
                        </div>
                        {% endif %}
                        {% if equipment.supplier %}
                        <div class="mb-3">
                            <label class="text-muted small">Dostawca</label>
                            <p class="mb-0">{{ equipment.supplier }}</p>
                        </div>
                        {% endif %}
                    </div>
                    <div class="col-md-6">
                        {% if equipment.invoiceNumber %}
                        <div class="mb-3">
                            <label class="text-muted small">Numer faktury</label>
                            <p class="mb-0">{{ equipment.invoiceNumber }}</p>
                        </div>
                        {% endif %}
                        {% if equipment.manufacturingDate %}
                        <div class="mb-3">
                            <label class="text-muted small">Data produkcji</label>
                            <p class="mb-0">{{ equipment.manufacturingDate|date('d.m.Y') }}</p>
                        </div>
                        {% endif %}
                        {% if equipment.warrantyExpiry %}
                        <div class="mb-3">
                            <label class="text-muted small">Koniec gwarancji</label>
                            <p class="mb-0">{{ equipment.warrantyExpiry|date('d.m.Y') }}</p>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
        {% endif %}

        <!-- Uwagi -->
        {% if equipment.notes %}
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="card-title mb-0">Uwagi</h5>
            </div>
            <div class="card-body">
                <p class="mb-0">{{ equipment.notes|nl2br }}</p>
            </div>
        </div>
        {% endif %}
    </div>

    <div class="col-xl-4">
        <!-- Status przypisania -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="ri-user-line me-2"></i>Przypisanie
                </h5>
            </div>
            <div class="card-body">
                {% if equipment.assignedTo %}
                <div class="d-flex align-items-center">
                    <div class="avatar-sm bg-warning rounded me-3">
                        <i class="ri-user-line text-white fs-16"></i>
                    </div>
                    <div>
                        <h6 class="mb-0">{{ equipment.assignedTo.fullName }}</h6>
                        <small class="text-muted">
                            Przypisane: {{ equipment.assignedDate|date('d.m.Y H:i') }}
                        </small>
                    </div>
                </div>
                {% else %}
                <div class="text-center py-3">
                    <i class="ri-user-unfollow-line text-muted fs-32"></i>
                    <p class="text-muted mb-0 mt-2">Nieprzypisane</p>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Przeglądy -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="ri-search-eye-line me-2"></i>Przeglądy
                </h5>
            </div>
            <div class="card-body">
                {% if equipment.nextReviewDate %}
                <div class="mb-3">
                    <label class="text-muted small">Następny przegląd</label>
                    <p class="mb-0">
                        {% set days_to_review = date(equipment.nextReviewDate).diff(date()).days %}
                        {% if days_to_review < 0 %}
                            <span class="text-danger fw-medium">
                                {{ equipment.nextReviewDate|date('d.m.Y') }}
                                <br><small>Przeterminowany!</small>
                            </span>
                        {% elseif days_to_review <= 30 %}
                            <span class="text-warning fw-medium">
                                {{ equipment.nextReviewDate|date('d.m.Y') }}
                                <br><small>Za {{ days_to_review }} dni</small>
                            </span>
                        {% else %}
                            <span class="fw-medium">
                                {{ equipment.nextReviewDate|date('d.m.Y') }}
                                <br><small class="text-muted">Za {{ days_to_review }} dni</small>
                            </span>
                        {% endif %}
                    </p>
                </div>
                {% endif %}

                {% if equipment.reviewIntervalMonths %}
                <div class="mb-3">
                    <label class="text-muted small">Okres przeglądu</label>
                    <p class="mb-0">{{ equipment.reviewIntervalMonths }} miesięcy</p>
                </div>
                {% endif %}

                {% set lastReview = equipment.lastReview %}
                {% if lastReview %}
                <div class="mb-3">
                    <label class="text-muted small">Ostatni przegląd</label>
                    <p class="mb-0">
                        <a href="{{ path('asekuracja_review_show', {id: lastReview.id}) }}" class="text-decoration-none">
                            {{ lastReview.completedDate|date('d.m.Y') }}
                            <i class="ri-external-link-line ms-1 small"></i>
                        </a>
                        <br><small class="text-muted">{{ lastReview.resultDisplayName }}</small>
                        {% if lastReview.certificateNumber %}
                            <br><small class="text-muted">Cert: {{ lastReview.certificateNumber }}</small>
                        {% endif %}
                    </p>
                </div>
                {% endif %}
                
                <!-- Historia przeglądów -->
                {% if reviews|length > 0 %}
                <div class="mt-3">
                    <label class="text-muted small">Historia przeglądów</label>
                    <div class="list-group list-group-flush">
                        {% for review in reviews|slice(0, 5) %}
                        <div class="list-group-item px-0 py-2 border-0 border-bottom">
                            <div class="d-flex justify-content-between align-items-start">
                                <div class="flex-grow-1">
                                    <a href="{{ path('asekuracja_review_show', {id: review.id}) }}" 
                                       class="text-decoration-none small fw-medium">
                                        {{ review.reviewNumber }}
                                    </a>
                                    {% if review.completedDate %}
                                    <div class="text-muted small">
                                        {{ review.completedDate|date('d.m.Y') }}
                                        {% if review.result %}
                                        <span class="ms-2 badge badge-sm bg-{{ review.result == 'passed' ? 'success' : (review.result == 'failed' ? 'danger' : 'warning') }}">
                                            {{ review.resultDisplayName }}
                                        </span>
                                        {% endif %}
                                    </div>
                                    {% else %}
                                    <div class="text-muted small">
                                        {% if review.status == 'preparation' %}Przygotowanie
                                        {% elseif review.status == 'sent' %}Wysłane ({{ review.sentDate|date('d.m.Y') }})
                                        {% else %}{{ review.status }}
                                        {% endif %}
                                    </div>
                                    {% endif %}
                                </div>
                                <i class="ri-external-link-line text-muted small"></i>
                            </div>
                        </div>
                        {% endfor %}
                        {% if reviews|length > 5 %}
                        <div class="text-center py-2">
                            <small class="text-muted">i {{ reviews|length - 5 }} więcej przeglądów...</small>
                        </div>
                        {% endif %}
                    </div>
                </div>
                {% endif %}
                
                <div class="d-grid mt-3">
                    {% if can_review %}
                    <button class="btn btn-outline-primary btn-sm">
                        <i class="ri-add-line me-1"></i>Nowy przegląd
                    </button>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Zestawy -->
        {% if equipment.equipmentSets|length > 0 %}
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="ri-stack-line me-2"></i>Zestawy
                </h5>
            </div>
            <div class="card-body">
                {% for equipmentSet in equipment.equipmentSets %}
                <div class="d-flex align-items-center mb-2">
                    <i class="ri-stack-line text-primary me-2"></i>
                    <a href="{{ path('asekuracja_equipment_set_show', {id: equipmentSet.id}) }}" 
                       class="text-decoration-none">
                        {{ equipmentSet.name }}
                    </a>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}

        <!-- Metadane -->
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="ri-information-line me-2"></i>Informacje systemowe
                </h5>
            </div>
            <div class="card-body">
                <div class="mb-2">
                    <label class="text-muted small">Utworzone</label>
                    <p class="mb-0 small">{{ equipment.createdAt|date('d.m.Y H:i') }}</p>
                    {% if equipment.createdBy %}
                    <small class="text-muted">przez {{ equipment.createdBy.fullName }}</small>
                    {% endif %}
                </div>
                {% if equipment.updatedAt and equipment.updatedAt != equipment.createdAt %}
                <div class="mb-0">
                    <label class="text-muted small">Ostatnia modyfikacja</label>
                    <p class="mb-0 small">{{ equipment.updatedAt|date('d.m.Y H:i') }}</p>
                    {% if equipment.updatedBy %}
                    <small class="text-muted">przez {{ equipment.updatedBy.fullName }}</small>
                    {% endif %}
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endblock %}