{% extends 'base.html.twig' %}

{% block title %}Logi systemu - AssetHub{% endblock %}
{% block page_title %}Logi systemu{% endblock %}

{% block breadcrumb %}
    <li class="breadcrumb-item"><a href="/">Strona główna</a></li>
    <li class="breadcrumb-item"><a href="/admin">Administracja</a></li>
    <li class="breadcrumb-item active">Logi systemu</li>
{% endblock %}

{% block content %}
<div class="row">
    <div class="col-lg-12">
        <div class="card">
            <div class="card-header">
                <div class="d-flex align-items-center">
                    <h5 class="card-title mb-0 flex-grow-1">Pliki logów systemu</h5>
                    <div class="flex-shrink-0">
                        <button type="button" class="btn btn-info" onclick="location.reload()">
                            <i class="ri-refresh-line me-1"></i> Odśwież
                        </button>
                    </div>
                </div>
            </div>
            <div class="card-body">
                {% if logFiles|length > 0 %}
                <div class="table-responsive">
                    <table class="table table-borderless table-centered align-middle table-nowrap mb-0">
                        <thead class="table-light">
                            <tr>
                                <th>Nazwa pliku</th>
                                <th>Rozmiar</th>
                                <th>Ostatnia modyfikacja</th>
                                <th>Akcje</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for logFile in logFiles %}
                            <tr>
                                <td>
                                    <div class="d-flex align-items-center">
                                        <div class="flex-shrink-0 me-3">
                                            <div class="avatar-sm">
                                                <span class="avatar-title bg-soft-primary text-primary rounded fs-3">
                                                    <i class="ri-file-text-line"></i>
                                                </span>
                                            </div>
                                        </div>
                                        <div class="flex-grow-1">
                                            <h6 class="mb-0">{{ logFile.name }}</h6>
                                            <p class="text-muted mb-0">{{ logFile.path }}</p>
                                        </div>
                                    </div>
                                </td>
                                <td>
                                    <span class="badge bg-light text-body">
                                        {% if logFile.size < 1024 %}
                                            {{ logFile.size }} B
                                        {% elseif logFile.size < 1048576 %}
                                            {{ (logFile.size / 1024)|round(1) }} KB
                                        {% else %}
                                            {{ (logFile.size / 1048576)|round(1) }} MB
                                        {% endif %}
                                    </span>
                                </td>
                                <td>
                                    <span class="text-muted">{{ logFile.modified|date('Y-m-d H:i:s') }}</span>
                                </td>
                                <td>
                                    <div class="d-flex gap-2">
                                        <a href="{{ path('admin_logs_view', {filename: logFile.name}) }}" 
                                           class="btn btn-sm btn-primary">
                                            <i class="ri-eye-line me-1"></i> Podgląd
                                        </a>
                                        <a href="{{ path('admin_logs_download', {filename: logFile.name}) }}" 
                                           class="btn btn-sm btn-success">
                                            <i class="ri-download-line me-1"></i> Pobierz
                                        </a>
                                        <button type="button" class="btn btn-sm btn-warning" 
                                                onclick="confirmClear('{{ logFile.name }}')">
                                            <i class="ri-delete-bin-line me-1"></i> Wyczyść
                                        </button>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="text-center py-5">
                    <lord-icon src="https://cdn.lordicon.com/msoeawqm.json" trigger="loop" 
                               colors="primary:#405189,secondary:#0ab39c" style="width:72px;height:72px">
                    </lord-icon>
                    <h5 class="mt-4">Brak plików logów</h5>
                    <p class="text-muted">W katalogu var/log nie znaleziono żadnych plików .log</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<div class="row mt-4">
    <div class="col-lg-12">
        <div class="card">
            <div class="card-header">
                <h6 class="card-title mb-0">
                    <i class="ri-information-line me-2"></i>
                    Informacje o logach
                </h6>
            </div>
            <div class="card-body">
                <div class="alert alert-info mb-0">
                    <h6 class="alert-heading">Zarządzanie logami systemu</h6>
                    <ul class="mb-0">
                        <li><strong>Podgląd</strong> - wyświetla ostatnie 1000 linii pliku logu</li>
                        <li><strong>Pobierz</strong> - pobiera pełny plik logu na komputer</li>
                        <li><strong>Wyczyść</strong> - usuwa zawartość pliku logu (nie usuwa pliku)</li>
                        <li><strong>Lokalizacja</strong> - pliki logów znajdują się w katalogu projektu var/log/</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Clear Log Modal -->
<div class="modal fade zoomIn" id="clearLogModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="mt-2 text-center">
                    <lord-icon src="https://cdn.lordicon.com/gsqxdxog.json" trigger="loop" 
                               colors="primary:#f7b84b,secondary:#f06548" style="width:100px;height:100px"></lord-icon>
                    <div class="mt-4 pt-2 fs-15 mx-4 mx-sm-5">
                        <h4>Czy na pewno?</h4>
                        <p class="text-muted mx-4 mb-0" id="clear-message">
                            Czy na pewno chcesz wyczyścić zawartość tego pliku logu? Ta operacja jest nieodwracalna.
                        </p>
                    </div>
                </div>
                <div class="d-flex gap-2 justify-content-center mt-4 mb-2">
                    <button type="button" class="btn w-sm btn-light" data-bs-dismiss="modal">Anuluj</button>
                    <form id="clear-form" method="post" style="display: inline;">
                        <input type="hidden" name="_token" id="clear-token">
                        <button type="submit" class="btn w-sm btn-warning">Tak, wyczyść!</button>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block javascript %}
<script>
function confirmClear(filename) {
    // Set up the clear form
    const form = document.getElementById('clear-form');
    form.action = `/admin/logs/clear/${filename}`;
    
    // Update message
    document.getElementById('clear-message').textContent = 
        `Czy na pewno chcesz wyczyścić zawartość pliku "${filename}"? Ta operacja jest nieodwracalna.`;
    
    // Generate CSRF token (in real app, you'd get this from Symfony)
    document.getElementById('clear-token').value = 'clear_log_' + filename;
    
    // Show modal
    const modal = new bootstrap.Modal(document.getElementById('clearLogModal'));
    modal.show();
}
</script>
{% endblock %}