{% extends 'base.html.twig' %}

{% block title %}{{ filename }} - Logi systemu - AssetHub{% endblock %}
{% block page_title %}Podgląd logu: {{ filename }}{% endblock %}

{% block breadcrumb %}
    <li class="breadcrumb-item"><a href="/">Strona główna</a></li>
    <li class="breadcrumb-item"><a href="/admin">Administracja</a></li>
    <li class="breadcrumb-item"><a href="{{ path('admin_logs') }}">Logi systemu</a></li>
    <li class="breadcrumb-item active">{{ filename }}</li>
{% endblock %}

{% block content %}
<div class="row">
    <div class="col-lg-12">
        <div class="card">
            <div class="card-header">
                <div class="d-flex align-items-center">
                    <h5 class="card-title mb-0 flex-grow-1">
                        <i class="ri-file-text-line me-2"></i>
                        {{ filename }}
                    </h5>
                    <div class="flex-shrink-0">
                        <a href="{{ path('admin_logs') }}" class="btn btn-light me-2">
                            <i class="ri-arrow-left-line me-1"></i> Powrót
                        </a>
                        <a href="{{ path('admin_logs_download', {filename: filename}) }}" class="btn btn-success me-2">
                            <i class="ri-download-line me-1"></i> Pobierz
                        </a>
                        <button type="button" class="btn btn-warning" onclick="confirmClear('{{ filename }}')">
                            <i class="ri-delete-bin-line me-1"></i> Wyczyść
                        </button>
                    </div>
                </div>
            </div>
            <div class="card-body">
                <div class="row mb-3">
                    <div class="col-md-4">
                        <div class="d-flex align-items-center">
                            <div class="flex-shrink-0 me-3">
                                <div class="avatar-sm">
                                    <span class="avatar-title bg-info-subtle text-info rounded fs-3">
                                        <i class="ri-file-info-line"></i>
                                    </span>
                                </div>
                            </div>
                            <div class="flex-grow-1">
                                <p class="text-muted mb-1">Rozmiar pliku</p>
                                <h6 class="mb-0">
                                    {% if fileSize < 1024 %}
                                        {{ fileSize }} B
                                    {% elseif fileSize < 1048576 %}
                                        {{ (fileSize / 1024)|round(1) }} KB
                                    {% else %}
                                        {{ (fileSize / 1048576)|round(1) }} MB
                                    {% endif %}
                                </h6>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="d-flex align-items-center">
                            <div class="flex-shrink-0 me-3">
                                <div class="avatar-sm">
                                    <span class="avatar-title bg-warning-subtle text-warning rounded fs-3">
                                        <i class="ri-time-line"></i>
                                    </span>
                                </div>
                            </div>
                            <div class="flex-grow-1">
                                <p class="text-muted mb-1">Ostatnia modyfikacja</p>
                                <h6 class="mb-0">{{ lastModified|date('Y-m-d H:i:s') }}</h6>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="d-flex align-items-center">
                            <div class="flex-shrink-0 me-3">
                                <div class="avatar-sm">
                                    <span class="avatar-title bg-success-subtle text-success rounded fs-3">
                                        <i class="ri-list-check"></i>
                                    </span>
                                </div>
                            </div>
                            <div class="flex-grow-1">
                                <p class="text-muted mb-1">Wyświetlone linie</p>
                                <h6 class="mb-0">Ostatnie {{ lines|length }}</h6>
                            </div>
                        </div>
                    </div>
                </div>

                {% if lines|length > 0 %}
                <div class="log-viewer">
                    <div class="card bg-dark">
                        <div class="card-header bg-dark border-0">
                            <div class="d-flex align-items-center">
                                <h6 class="text-light mb-0">Zawartość logu (ostatnie {{ lines|length }} linii)</h6>
                                <div class="ms-auto">
                                    <button type="button" class="btn btn-sm btn-outline-light" onclick="toggleLineNumbers()">
                                        <i class="ri-list-ordered"></i> Numery linii
                                    </button>
                                    <button type="button" class="btn btn-sm btn-outline-light" onclick="toggleWordWrap()">
                                        <i class="ri-text-wrap"></i> Zawijanie
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div class="card-body bg-dark p-0">
                            <pre id="log-content" class="text-light mb-0 p-3" style="max-height: 600px; overflow-y: auto; font-family: 'Courier New', monospace; font-size: 12px; line-height: 1.4;">{% for line in lines %}{{ line }}
{% endfor %}</pre>
                        </div>
                    </div>
                </div>
                {% else %}
                <div class="text-center py-5">
                    <lord-icon src="https://cdn.lordicon.com/msoeawqm.json" trigger="loop" 
                               colors="primary:#405189,secondary:#0ab39c" style="width:72px;height:72px">
                    </lord-icon>
                    <h5 class="mt-4">Plik logu jest pusty</h5>
                    <p class="text-muted">Nie znaleziono żadnych wpisów w pliku {{ filename }}</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Clear Log Modal -->
<div class="modal fade zoomIn" id="clearLogModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="mt-2 text-center">
                    <lord-icon src="https://cdn.lordicon.com/gsqxdxog.json" trigger="loop" 
                               colors="primary:#f7b84b,secondary:#f06548" style="width:100px;height:100px"></lord-icon>
                    <div class="mt-4 pt-2 fs-15 mx-4 mx-sm-5">
                        <h4>Czy na pewno?</h4>
                        <p class="text-muted mx-4 mb-0">
                            Czy na pewno chcesz wyczyścić zawartość pliku "{{ filename }}"? Ta operacja jest nieodwracalna.
                        </p>
                    </div>
                </div>
                <div class="d-flex gap-2 justify-content-center mt-4 mb-2">
                    <button type="button" class="btn w-sm btn-light" data-bs-dismiss="modal">Anuluj</button>
                    <form id="clear-form" method="post" style="display: inline;">
                        <input type="hidden" name="_token" id="clear-token">
                        <button type="submit" class="btn w-sm btn-warning">Tak, wyczyść!</button>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block head_css %}
{{ parent() }}
<style>
.log-viewer pre {
    white-space: pre;
    word-wrap: normal;
    overflow-x: auto;
}

.log-viewer pre.line-numbers {
    counter-reset: line;
}

.log-viewer pre.line-numbers .line::before {
    counter-increment: line;
    content: counter(line);
    display: inline-block;
    width: 4em;
    text-align: right;
    margin-right: 1em;
    color: #6c757d;
    border-right: 1px solid #495057;
    padding-right: 0.5em;
}

.log-viewer pre.word-wrap {
    white-space: pre-wrap;
    word-wrap: break-word;
}
</style>
{% endblock %}

{% block javascript %}
<script>
let lineNumbersEnabled = false;
let wordWrapEnabled = false;

function toggleLineNumbers() {
    const logContent = document.getElementById('log-content');
    lineNumbersEnabled = !lineNumbersEnabled;
    
    if (lineNumbersEnabled) {
        logContent.classList.add('line-numbers');
        // Wrap each line in a span
        const lines = logContent.textContent.split('\n');
        logContent.innerHTML = lines.map(line => `<span class="line">${line}</span>`).join('\n');
    } else {
        logContent.classList.remove('line-numbers');
        // Restore original content
        logContent.innerHTML = logContent.textContent;
    }
}

function toggleWordWrap() {
    const logContent = document.getElementById('log-content');
    wordWrapEnabled = !wordWrapEnabled;
    
    if (wordWrapEnabled) {
        logContent.classList.add('word-wrap');
    } else {
        logContent.classList.remove('word-wrap');
    }
}

function confirmClear(filename) {
    // Set up the clear form
    const form = document.getElementById('clear-form');
    form.action = `/admin/logs/clear/${filename}`;
    
    // Generate CSRF token (in real app, you'd get this from Symfony)
    document.getElementById('clear-token').value = 'clear_log_' + filename;
    
    // Show modal
    const modal = new bootstrap.Modal(document.getElementById('clearLogModal'));
    modal.show();
}

// Auto-scroll to bottom of log
document.addEventListener('DOMContentLoaded', function() {
    const logContent = document.getElementById('log-content');
    if (logContent) {
        logContent.scrollTop = logContent.scrollHeight;
    }
});
</script>
{% endblock %}